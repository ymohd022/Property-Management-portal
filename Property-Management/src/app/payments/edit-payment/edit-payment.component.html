<div class="edit-payment-dialog">
  <h2 mat-dialog-title>Edit Payment</h2>
  
  <mat-dialog-content>
    <form [formGroup]="paymentForm" (ngSubmit)="onSubmit()">
      <!-- Property and Flat Information (Read-only) -->
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Property</mat-label>
          <input matInput [value]="data.payment.property_name" readonly>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Flat</mat-label>
          <input matInput [value]="data.payment.flat_number + ' (Floor ' + data.payment.floor_number + ')'" readonly>
        </mat-form-field>
      </div>

      <!-- Flat Details Card -->
      <mat-card *ngIf="flatDetails" appearance="outlined" class="flat-details-card">
        <mat-card-content>
          <div class="flat-details-grid">
            <div class="detail-item">
              <span class="detail-label">Floor No:</span>
              <span class="detail-value">{{ flatDetails.floor_number }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Flat No:</span>
              <span class="detail-value">{{ flatDetails.flat_number }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">BHK Type:</span>
              <span class="detail-value">{{ flatDetails.bhk_type }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Parking:</span>
              <span class="detail-value">{{ flatDetails.has_parking ? 'Yes' : 'No' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Area:</span>
              <span class="detail-value">{{ flatDetails.flat_size }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">UDS:</span>
              <span class="detail-value">{{ flatDetails.uds }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Sold By:</span>
              <span class="detail-value">{{ flatDetails.sold_by_name || '-' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Flat Owner:</span>
              <span class="detail-value">{{ flatDetails.flat_owner || '-' }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Payment Details -->
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Payment Date</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="payment_date" required>
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="paymentForm.get('payment_date')?.hasError('required')">
            Payment date is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Payment Category</mat-label>
          <mat-select formControlName="payment_category" required>
            <mat-option *ngFor="let category of paymentCategories" [value]="category">
              {{ category }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="paymentForm.get('payment_category')?.hasError('required')">
            Payment category is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Payment Type</mat-label>
          <mat-select formControlName="payment_type" required>
            <mat-option *ngFor="let type of paymentTypes" [value]="type">
              {{ type }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="paymentForm.get('payment_type')?.hasError('required')">
            Payment type is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Amount</mat-label>
          <input matInput type="number" formControlName="payment_amount" required>
          <span matTextPrefix>â‚¹&nbsp;</span>
          <mat-error *ngIf="paymentForm.get('payment_amount')?.hasError('required')">
            Amount is required
          </mat-error>
          <mat-error *ngIf="paymentForm.get('payment_amount')?.hasError('min')">
            Amount must be greater than 0
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Reference Number</mat-label>
          <input matInput formControlName="reference_number">
          <mat-hint>Required for Cheque/UPI/Bank Transfer</mat-hint>
        </mat-form-field>
      </div>

      <!-- Receipt Image Upload -->
      <div class="form-row">
        <div class="file-upload-container">
          <!-- Show existing image if available -->
          <div *ngIf="existingImageUrl" class="existing-image-container">
            <img [src]="existingImageUrl" alt="Receipt" class="receipt-thumbnail">
            <button type="button" mat-icon-button color="warn" (click)="removeExistingImage()" matTooltip="Remove Image">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          
          <button type="button" mat-stroked-button (click)="fileInput.click()">
            <mat-icon>attach_file</mat-icon>
            {{ selectedFile ? 'Change Receipt Image' : (existingImageUrl ? 'Replace Receipt Image' : 'Add Receipt Image') }}
          </button>
          <input hidden type="file" #fileInput (change)="onFileSelected($event)" accept="image/*">
          <span *ngIf="selectedFile" class="file-name">{{ selectedFile.name }}</span>
        </div>
      </div>

      <!-- Comments -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Comments</mat-label>
          <textarea matInput formControlName="comments" rows="3"></textarea>
        </mat-form-field>
      </div>
    </form>
  </mat-dialog-content>
  
  <mat-dialog-actions align="end">
    <button mat-button (click)="onCancel()" [disabled]="isLoading">Cancel</button>
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="isLoading">
      <mat-spinner *ngIf="isLoading" diameter="20" class="button-spinner"></mat-spinner>
      <span>Update Payment</span>
    </button>
  </mat-dialog-actions>
</div>